---
title: "2023-11-13_celltype_proprotion_all_trans_props_regression_pathology_scores"
author: "Ruqian Lyu"
date: "2023-11-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages({
  library(ggplot2)
  library(dplyr)
  library(cowplot)
  library(scater)
  library(Seurat)
  library(speckle)
  library(limma)
})
```

## Cell type counts 

Transform cell type proportions with `speckle::propeller`

```{r,fig.width=8}
pathology_scores <- readr::read_csv(file = "../../Datasets/Lung/Xenium_2023/Lumen_seg/lumen_sep2023/lumen_pca_090523/Pathology_scoring_11-06-23.csv")

pathology_scores <- pathology_scores %>% tidyr::pivot_longer(cols = 2:ncol(pathology_scores))
colnames(pathology_scores) <- c("Feature","Sample","Score")

pathology_scores %>% ggplot()+geom_point(mapping = aes(x = Sample,y=Score)) +
  facet_wrap(.~Feature,scales = "free_y")+theme(axis.text.x = element_text(angle=90))

cell_object <- readRDS(file = "../../Datasets/Lung/cell_Seurat_obj/Xenium/Aug1_obj/full_xenium_07-13-23.rds")
remove_cellid_105LF <- read.csv(file = "../../Datasets/Lung/Xenium_2023/remove_nuclei_transcripts_091223/remove_nuclei_VUILD105LF.csv")
remove_cellid_105LF$Cell.ID <- paste0("VUILD105LF_",remove_cellid_105LF$Cell.ID)
dim(remove_cellid_105LF)
sum(remove_cellid_105LF$Cell.ID %in% Cells(cell_object))

cell_object_fix105LF <- cell_object[,!Cells(cell_object) %in% remove_cellid_105LF$Cell.ID]
dim(cell_object_fix105LF)
sample_name_to_type <- unique(cell_object_fix105LF@meta.data[,c("sample","sample_type")])

```

### broad CT5

```{r,fig.width=8}

### broad CT 5
nuclei_celltype <- cell_object_fix105LF@meta.data

sample_broad_CT5_types <- nuclei_celltype %>% group_by(sample,tma,run,broad_CT5,sample_type) %>% 
  summarise(celltype_count=n()) %>% 
  tidyr::pivot_wider(names_from = "broad_CT5",values_from = celltype_count)

sample_broad_CT5_types_matrix <- sample_broad_CT5_types %>% select(tail(names(.), 39)) %>%
  mutate_all( ~coalesce(.,0))
dim(sample_broad_CT5_types_matrix)
sample_broad_CT5_types_m <- sample_broad_CT5_types_matrix[,(-1:-3)]
dim(sample_broad_CT5_types_m)
sample_broad_CT5_types_m <- as.matrix(sample_broad_CT5_types_m)

sample_broad_CT5_types_matrix$total_cells <- rowSums(sample_broad_CT5_types_matrix[,(-1:-3)])

rownames(sample_broad_CT5_types_m) <- sample_broad_CT5_types_matrix$sample

broad_CT5_types_sce <- SingleCellExperiment(assays= list("broad_CT5_count" = t(sample_broad_CT5_types_m)))
dim(broad_CT5_types_sce)
colData(broad_CT5_types_sce) <- cbind(colData(broad_CT5_types_sce),data.frame(sample_broad_CT5_types,check.names = F))
dim(broad_CT5_types_sce)

broad_CT5_types_sce <- addPerCellQC(broad_CT5_types_sce, assay.type = "broad_CT5_count")
pathology_scores_only <- pathology_scores[pathology_scores$Feature == "Adjusted_path_score",]
dim(broad_CT5_types_sce)
plotColData(broad_CT5_types_sce,x="sample",
            y=c("total"),other_fields = "sample_type")+
  facet_wrap(.~sample_type,scale="free_x")

broad_CT5_types_sce$pathology_scores <- pathology_scores_only$Score[match(broad_CT5_types_sce$sample,pathology_scores_only$Sample)]

# plotColData(broad_CT5_types_sce,x="sample",y=c("pathology_scores"),
#             other_fields = "sample_type")+
#   facet_wrap(.~sample_type,scale="free_x")
# 
# data.frame(colData(broad_CT5_types_sce)) %>% ggplot() + geom_boxplot(mapping = aes(x = sample_type, 
#                                                                                  y = pathology_scores))

data.frame(colData(broad_CT5_types_sce),check.names = F) %>% 
  tidyr::pivot_longer(cols = colnames(sample_broad_CT5_types_m),
                      names_to = "broad_CT5",
                      values_to = "cell_count") %>% mutate(cell_prop = cell_count/total) %>%
  ggplot() + geom_point(mapping = aes(x = pathology_scores, y = cell_prop, color = broad_CT5)) +
  geom_line(mapping = aes(x = pathology_scores, y = cell_prop, color = broad_CT5))+
  facet_wrap(.~broad_CT5,scales = "free_y")

data.frame(colData(broad_CT5_types_sce),check.names = F) %>% 
  tidyr::pivot_longer(cols = colnames(sample_broad_CT5_types_m),
                      names_to = "broad_CT5",
                      values_to = "cell_count") %>% mutate(cell_prop = cell_count/total) %>%
  ggplot() + geom_point(mapping = aes(x = pathology_scores, y = cell_prop, color = broad_CT5)) +
  geom_smooth(mapping = aes(x = pathology_scores, y = cell_prop, color = broad_CT5))+
  facet_wrap(.~broad_CT5,scales = "free_y")



```

### remove a cell type that are of low count

```{r}

## remove some cell types
filter_ct <- data.frame(colData(broad_CT5_types_sce),check.names = F) %>% 
  tidyr::pivot_longer(cols = colnames(sample_broad_CT5_types_m),
                      names_to = "broad_CT5",
                      values_to = "cell_count") %>% mutate(cell_count_m10 = cell_count > 10) %>%
  group_by(broad_CT5) %>% summarise(keep_celltype = sum(cell_count_m10,na.rm = T) > 10) %>% 
  filter(!keep_celltype)
filter_ct
```


Remove the cells labelled as Mesothelial

## Propeller function to transform the proportion

```{r}
cell_meta <- cell_object_fix105LF@meta.data
#cell_meta <- cell_meta[cell_meta$sample!="THD0008",]
cell_meta <- cell_meta[!cell_meta$broad_CT5 %in% filter_ct$broad_CT5,]
dim(cell_meta)
```

```{r}
table(cell_meta$sample, cell_meta$broad_CT5)[1:4,1:4]
```

getTransformedProp

```{r}
broad_ct5_prop_trans = getTransformedProps(clusters = cell_meta$broad_CT5, 
                                           sample = cell_meta$sample, transform = "logit")
```

```{r}
pscores <- broad_CT5_types_sce$pathology_scores[match(colnames(broad_ct5_prop_trans$Counts),
                                                      broad_CT5_types_sce$sample )]
patient_id <- cell_meta$patient[match(colnames(broad_ct5_prop_trans$Counts), cell_meta$sample )]
sample_name <- cell_meta$sample[match(colnames(broad_ct5_prop_trans$Counts), cell_meta$sample )]
sample_type <- cell_meta$sample_type[match(colnames(broad_ct5_prop_trans$Counts), cell_meta$sample )]

des_pscore <- model.matrix(~pscores)
des_pscore
```

```{r}
fit <- lmFit(broad_ct5_prop_trans$TransformedProps,des_pscore)
fit <- eBayes(fit, robust=TRUE)
fit_res_logres <- topTable(fit,p.value = 0.01,number = Inf)
fit_res_logres
```

```{r}
fit_res_logres_all <- topTable(fit,p.value = 1,number = Inf)
fit_res_logres_all
```

```{r}
fit_res_logres_all$celltype <- rownames(fit_res_logres_all)
readr::write_csv(fit_res_logres_all, file = "output/savedFiles/celltype_prop_all_changes_adjpathology_scores.csv")
```


Fit the linear model on raw proportion to calculate the fold change and in the original proportion 
space for visualisation.

```{r}
fit.prop <- lmFit(broad_ct5_prop_trans$Proportions,des_pscore)
fit.prop <- eBayes(fit.prop, robust=TRUE)
topTable(fit.prop)
```

```{r}
head(fit.prop$coefficients)
```

```{r,fig.width=8,fig.height=8}
par(mfrow=c(3,3))
for(i in seq(1,18,1)){
    plot(pscores, broad_ct5_prop_trans$Proportions[i,],
         main = rownames(broad_ct5_prop_trans$Proportions)[i], 
        pch=16, cex=2, ylab="Proportions", cex.lab=1.5, cex.axis=1.5,
        cex.main=2)
    abline(a=fit.prop$coefficients[i,1], b=fit.prop$coefficients[i,2], col=4, 
            lwd=2)
}

```

### Split by positive lfc 

```{r}
all_sig_c <- topTable(fit,p.value = 0.01,number = Inf)
pos_c <- rownames(all_sig_c[which(all_sig_c$logFC > 0 ),])
neg_c <- rownames(all_sig_c[which(all_sig_c$logFC  < 0), ])
length(pos_c)
length(neg_c)
```


```{r,fig.width=8,fig.height=8}
par(mfrow=c(3,3))
for(i in pos_c){
    plot(pscores, broad_ct5_prop_trans$Proportions[i,],
         main = i, 
        pch=16, cex=2, ylab="Proportions", cex.lab=1.5, cex.axis=1.5,
        cex.main=2)
    abline(a=fit.prop$coefficients[i,1], b=fit.prop$coefficients[i,2], col=4, 
            lwd=2)
}

par(mfrow=c(3,3))
for(i in neg_c){
    plot(pscores, broad_ct5_prop_trans$Proportions[i,],
         main = i, 
        pch=16, cex=2, ylab="Proportions", cex.lab=1.5, cex.axis=1.5,
        cex.main=2)
    abline(a=fit.prop$coefficients[i,1], b=fit.prop$coefficients[i,2], col=4, 
            lwd=2)
}

```

```{r}
all_sig_c$celltype <- rownames(all_sig_c)
#readr::write_csv(all_sig_c, file = "output/savedFiles/celltype_prop_changes_adjpathology_scores.csv")
```

```{r}
all_sig_c %>% ggplot()+geom_point(mapping = aes(x = logFC,y = -log10(adj.P.Val)))+
  theme_bw(base_size = 15)
```


### Adding random effect

It has little effect on the results.

```{r}
#des.tech <- model.matrix(~patient_id)

dupcor <- duplicateCorrelation(broad_ct5_prop_trans$TransformedProps, design=des_pscore,
                                block=patient_id)
dupcor
```

```{r}
# Fitting the linear model accounting for pair as a random effect
fit1 <- lmFit(broad_ct5_prop_trans$TransformedProps, design=des_pscore, block=patient_id, 
                correlation=dupcor$consensus)
fit1 <- eBayes(fit1)
#summary(decideTests(fit1))
```

```{r}
topTable(fit1,coef = 2)
```


```{r}
all_sig_c <- topTable(fit1,p.value = 0.01,number = Inf)
pos_c <- rownames(all_sig_c[which(all_sig_c$logFC > 0 ),])
neg_c <- rownames(all_sig_c[which(all_sig_c$logFC < 0), ])
length(pos_c)
length(neg_c)
```


```{r,fig.width=8,fig.height=8}
par(mfrow=c(3,3))
for(i in pos_c){
    plot(pscores, broad_ct5_prop_trans$Proportions[i,],
         main = i, 
        pch=16, cex=2, ylab="Proportions", cex.lab=1.5, cex.axis=1.5,
        cex.main=2)
    abline(a=fit.prop$coefficients[i,1], b=fit.prop$coefficients[i,2], col=4, 
            lwd=2)
}

par(mfrow=c(3,3))
for(i in neg_c){
    plot(pscores, broad_ct5_prop_trans$Proportions[i,],
         main = i, 
        pch=16, cex=2, ylab="Proportions", cex.lab=1.5, cex.axis=1.5,
        cex.main=2)
    abline(a=fit.prop$coefficients[i,1], b=fit.prop$coefficients[i,2], col=4, 
            lwd=2)
}

```

## Pseudobulk gene expression into sample level

```{r}
nuclei_expr <- cell_object_fix105LF@assays$RNA@counts
hist(colSums(nuclei_expr))
```
```{r}
cell_expr <- cell_object_fix105LF@assays$cell_RNA@counts
hist(colSums(cell_expr))

```


```{r}
t(cell_expr)[1:5,1:5]
```


sample-level gene expression aggregation

```{r}
#cell_expr_t
cell_RNA_expr <- t(sapply(by(t(cell_expr),as.character(cell_object_fix105LF$sample),colSums),identity))
dim(cell_RNA_expr)
```

```{r}
cell_RNA_expr[1:4,1:5]
```


`getTransformedProp`

```{r}
getTransformedProps_fromCountM <- function(count_m,transform = "logit"){

    tab <- count_m
    props <- tab/rowSums(tab)
    if (transform == "asin") {
        message("Performing arcsin square root transformation of proportions")
        prop.trans <- asin(sqrt(props))
    }
    else if (transform == "logit") {
        message("Performing logit transformation of proportions")
        props.pseudo <- (tab + 0.5)/rowSums(tab + 0.5)
        prop.trans <- log(props.pseudo/(1 - props.pseudo))
    }
    return(list(Counts = t(tab), TransformedProps = t(prop.trans), 
        Proportions = t(props)))
}
```

```{r}
#cell_RNA_expr_rm08 <- cell_RNA_expr[rownames(cell_RNA_expr)!="THD0008",]
cell_RNA_prop_trans = getTransformedProps_fromCountM(count_m = cell_RNA_expr, transform = "logit")
```

```{r}
pscores <- broad_CT5_types_sce$pathology_scores[match(colnames(cell_RNA_prop_trans$Counts), 
                                                      broad_CT5_types_sce$sample )]

patient_id <- cell_meta$patient[match(colnames(cell_RNA_prop_trans$Counts), cell_meta$sample )]
sample_name <- cell_meta$sample[match(colnames(cell_RNA_prop_trans$Counts), cell_meta$sample )]
sample_type <- cell_meta$sample_type[match(colnames(cell_RNA_prop_trans$Counts), cell_meta$sample )]

des_pscore <- model.matrix(~pscores)
des_pscore
dim(des_pscore)
```

```{r}
fit_cell_RNA_prop_logit <- lmFit(cell_RNA_prop_trans$TransformedProps,des_pscore)
fit_cell_RNA_prop_logit <- eBayes(fit_cell_RNA_prop_logit, robust=TRUE)
topTable(fit_cell_RNA_prop_logit,p.value = 0.01,number = 10)
```

Fit raw prop to get estimates for plotting

```{r}
fit.prop <- lmFit(cell_RNA_prop_trans$Proportions,des_pscore)
fit.prop <- eBayes(fit.prop, robust=TRUE)
topTable(fit.prop)
```

```{r}
head(fit.prop$coefficients)
```

### Split by positive or neg lfc 

Plot for top 30 DEGs

```{r}
all_sig_c <- topTable(fit_cell_RNA_prop_logit,p.value = 0.01,number = 30)
pos_c <- rownames(all_sig_c[which(all_sig_c$logFC > 0 ),])
neg_c <- rownames(all_sig_c[which(all_sig_c$logFC  < 0), ])
length(pos_c)
length(neg_c)
```


```{r,fig.width=8,fig.height=8}
par(mfrow=c(4,4))
for(i in pos_c){
    plot(pscores, cell_RNA_prop_trans$Proportions[i,],
         main = i, 
        pch=16, cex=2, ylab="Proportions", cex.lab=1.5, cex.axis=1.5,
        cex.main=2)
    abline(a=fit.prop$coefficients[i,1], b=fit.prop$coefficients[i,2], col=4, 
            lwd=2)
}

par(mfrow=c(4,4))
for(i in neg_c){
    plot(pscores, cell_RNA_prop_trans$Proportions[i,],
         main = i, 
        pch=16, cex=2, ylab="Proportions", cex.lab=1.5, cex.axis=1.5,
        cex.main=2)
    abline(a=fit.prop$coefficients[i,1], b=fit.prop$coefficients[i,2], col=4, 
            lwd=2)
}

```

dot plot for visualisation

```{r}
all_sig_c <- topTable(fit_cell_RNA_prop_logit,p.value = 0.01,
                      sort.by = "P",number = 15)
dim(all_sig_c)
all_sig_c$gene <- rownames(all_sig_c)
all_results <- topTable(fit_cell_RNA_prop_logit,
                        p.value = 1,number = Inf)

all_results %>% ggplot() + geom_point(mapping = aes(x = logFC,
                                                    y = -log10(adj.P.Val),
                                                    color = adj.P.Val < 0.01 )) +
  theme_bw(base_size = 15) +
  ggrepel::geom_text_repel(data = all_sig_c,mapping = aes(x = logFC,
                                                    y = -log10(adj.P.Val),
                                            label = gene))
```


```{r}
all_results$gene <- rownames(all_results)
readr::write_csv(all_results, file ="output/savedFiles/all_trans_prop_changes_adjpathology_scores.csv")
```

## Pseudobulk cell RNA per cell type

```{r}
sample_celltype_levels <-  paste0(as.character(cell_object_fix105LF$sample),"_",
                                  as.character(cell_object_fix105LF$broad_CT5))
cell_RNA_expr_perCT <- t(sapply(by(t(cell_expr),sample_celltype_levels,colSums),identity))
dim(cell_RNA_expr_perCT)
```


```{r}
# cell_RNA_expr_perCT_rm08 <- cell_RNA_expr_perCT[!grepl("THD0008",rownames(cell_RNA_expr_perCT)),]
# dim(cell_RNA_expr_perCT_rm08)
# dim(cell_RNA_expr_perCT)

cell_RNA_expr_perCT_prop_trans = getTransformedProps_fromCountM(count_m = cell_RNA_expr_perCT,
                                                                  transform = "logit")
```

```{r}
cell_RNA_expr_perCT_prop_trans$Counts[1:4,1:4]
cell_RNA_expr_perCT_prop_trans$Proportions[1:4,1:4]

```


```{r}
pscores <- broad_CT5_types_sce$pathology_scores[match(sapply(strsplit(colnames(cell_RNA_expr_perCT_prop_trans$Counts),"_"),`[[`,1), broad_CT5_types_sce$sample )]

patient_id <- cell_meta$patient[match(sapply(strsplit(colnames(cell_RNA_expr_perCT_prop_trans$Counts),"_"),`[[`,1), 
                                      cell_meta$sample )]
sample_name <- cell_meta$sample[match(sapply(strsplit(colnames(cell_RNA_expr_perCT_prop_trans$Counts),"_"),`[[`,1), 
                                      cell_meta$sample )]
sample_type <- cell_meta$sample_type[match(sapply(strsplit(colnames(cell_RNA_expr_perCT_prop_trans$Counts),"_"),`[[`,1), cell_meta$sample )]

des_pscore <- model.matrix(~pscores)
head(des_pscore)
dim(des_pscore)
```


```{r}
test_celltypes <- rownames(broad_ct5_prop_trans$Counts)
cell_type_levels <- sapply(strsplit(colnames(cell_RNA_expr_perCT_prop_trans$Counts),"_"),`[[`,2)
res_per_ct = list()
for(each_ct in test_celltypes) {
  fit_cell_RNA_prop <- lmFit(cell_RNA_expr_perCT_prop_trans$TransformedProps[,cell_type_levels %in% each_ct],
                               des_pscore[cell_type_levels %in% each_ct,])
  fit_cell_RNA_prop <- eBayes(fit_cell_RNA_prop, robust=TRUE)
  res = topTable(fit_cell_RNA_prop,p.value = 1, number = Inf)
  if(nrow(res) >0 ){
      res$gene <- rownames(res)
      res$celltype <- each_ct
      res_per_ct[[each_ct]] = res
  }
}
```

```{r}
res_per_ct_sig_genes <- do.call(rbind,res_per_ct)
#readr::write_csv(res_per_ct_sig_genes,file =)
```

```{r}
res_per_ct_df <- do.call(rbind,res_per_ct_df)
readr::write_csv(res_per_ct_df,file="output/savedFiles/all_trans_prop_changes_per_ct_adjpathology_scores.csv")
```
